# Creation Service

Video processing and YouTube upload service.

## Overview

The creation service handles:
- Consuming video generation requests from Kafka
- Processing videos with FFmpeg (adding background, audio, subtitles)
- Uploading videos to YouTube with metadata
- Supporting multiple operation modes (API, Kafka, Batch)
- In docker-compose, three instances run in parallel (`tech`, `finance`, `other`) so each topic can publish to its own YouTube channel/slot.

## Setup

### Prerequisites

- Go 1.24+
- FFmpeg installed
- YouTube OAuth credentials
- Kafka running (for Kafka mode)

### YouTube OAuth Setup (multi-account)

Run the setup script for your first channel:

```bash
cd scripts
./setup_creation_service_credentials.sh --slot 1 --client-secret client_secret.json
```

Repeat for additional accounts by bumping the slot number and pointing at the matching client-secret file (e.g., `--slot 2 --client-secret client_secret_2.json`).

The script will:
1. Walk you through the OAuth consent flow (reusing cached tokens when available)
2. Store a token cache per slot at `.secrets/youtube_oauth_slot<slot>.json`
3. Update the project root `.env` with `YOUTUBE_CLIENT_ID_<slot>`, `YOUTUBE_CLIENT_SECRET_<slot>`, and `YOUTUBE_REFRESH_TOKEN_<slot>` entries, plus set `YOUTUBE_ACCOUNT_SLOT` to the most recently configured slot

To switch accounts at runtime, edit the root `.env` `YOUTUBE_ACCOUNT_SLOT` (or just export it in your shell before launching the service).

### Environment Variables

```bash
# YouTube OAuth (generated by setup script)

YOUTUBE_CLIENT_ID_1=your_first_account_client_id
YOUTUBE_CLIENT_SECRET_1=your_first_account_client_secret
YOUTUBE_REFRESH_TOKEN_1=refresh_token_value

YOUTUBE_CLIENT_ID_2=your_second_account_client_id
YOUTUBE_CLIENT_SECRET_2=...
YOUTUBE_REFRESH_TOKEN_2=...

# Kafka configuration (for Kafka mode)
KAFKA_BOOTSTRAP_SERVERS=localhost:9093
KAFKA_TOPIC_VIDEO_REQUESTS=video-processing-requests
KAFKA_CONSUMER_GROUP_ID=creation-service-consumer-group
```

## Running Modes

### Kafka Consumer Mode (Default)

Continuously consumes video requests from Kafka:

```bash
# Load YouTube credentials
source ../.env

# (Optional) override which slot to use for this run
export YOUTUBE_ACCOUNT_SLOT=2

# Run in Kafka mode
go run main.go -kafka
```

### API Mode

Exposes HTTP API for video processing:

```bash
go run main.go -port :8081
```

API endpoint:
```bash
POST /api/process-video
Content-Type: application/json

{
  "script": "Video script text...",
  "video_url": "https://...",
  "audio_url": "https://...",
  "captions": [
    {"start": 0.0, "end": 2.5, "text": "Hello"},
    {"start": 2.5, "end": 5.0, "text": "World"}
  ],
  "title": "Video Title",
  "description": "Video description"
}
```

### Batch Mode

Process all JSON files from `inputs/` directory:

```bash
go run main.go -batch
```

## Build & Run

```bash
# Build
go build -o creation-service main.go

# Run in Kafka mode
./creation-service -kafka

# Run in API mode
./creation-service -port :8081

# Run in batch mode
./creation-service -batch
```

## Docker

```bash
# Build
docker build -t brainbot-creation .

# Run (Kafka mode)
docker run \
  --env-file ../.env \
  -e YOUTUBE_ACCOUNT_SLOT=1 \
  -e KAFKA_BOOTSTRAP_SERVERS=kafka:9092 \
  brainbot-creation
```

## Troubleshooting

**FFmpeg errors:**
- Verify FFmpeg is installed: `ffmpeg -version`
- Check background videos exist in `backgroundvids/`

**YouTube upload errors:**
- Verify OAuth tokens: Re-run `./scripts/setup_creation_service_credentials.sh`
- Check YouTube API quota

**Kafka connection errors:**
- Verify Kafka is running
- Check topic exists in Kafka UI
